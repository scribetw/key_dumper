name: Build Key Dumper

on:
  push:
    branches: [ main, master ]
    paths:
      - 'key_dumper/**'
      - '.github/workflows/build-key-dumper.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'key_dumper/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup vcpkg
      run: echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" >> $env:GITHUB_ENV
    
    - name: Configure CMake
      working-directory: key_dumper
      run: cmake -Bbuild -A Win32 -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" -DCMAKE_BUILD_TYPE=Release .
    
    - name: Build
      working-directory: key_dumper
      run: cmake --build build --config Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: key-dumper-binaries
        path: |
          key_dumper/build/src/Release/*.dll
          key_dumper/build/src/Release/*.exe
        if-no-files-found: warn
