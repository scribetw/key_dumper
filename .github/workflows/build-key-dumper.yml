name: Build Key Dumper

on:
  push:
    branches: [ main, master ]
    paths:
      - 'key_dumper/**'
      - '.github/workflows/build-key-dumper.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'key_dumper/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Download MinHook
      run: |
        Invoke-WebRequest -Uri "https://github.com/TsudaKageyu/minhook/archive/refs/tags/v1.3.3.zip" -OutFile minhook.zip
        Expand-Archive -Path minhook.zip -DestinationPath .
        Move-Item minhook-1.3.3 key_dumper/deps/minhook
    
    - name: Build MinHook
      working-directory: key_dumper/deps/minhook
      run: |
        cmake -Bbuild -A Win32 -DCMAKE_BUILD_TYPE=Release .
        cmake --build build --config Release
    
    - name: Copy MinHook library
      run: |
        Copy-Item "key_dumper/deps/minhook/build/Release/minhook.lib" "key_dumper/lib/"
        Copy-Item "key_dumper/deps/minhook/include/MinHook.h" "key_dumper/include/"
    
    - name: Configure CMake
      working-directory: key_dumper
      run: cmake -Bbuild -A Win32 -DCMAKE_BUILD_TYPE=Release .
    
    - name: Build
      working-directory: key_dumper
      run: cmake --build build --config Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: key-dumper-binaries
        path: |
          key_dumper/build/src/Release/*.dll
          key_dumper/build/src/Release/*.exe
        if-no-files-found: warn
